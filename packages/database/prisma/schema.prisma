generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// === Phase 1: Foundation models (schema exists, data operations in Phase 2) ===

model User {
  id                  String           @id @default(uuid())
  email               String           @unique
  firstName           String
  lastName            String
  passwordHash        String
  mustChangePassword  Boolean          @default(true)
  isActive            Boolean          @default(true)
  role                String           @default("PLAYER")  // PLAYER | SUPER_ADMIN
  lastLoginAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  refreshTokens       RefreshToken[]
  playerProgress      PlayerProgress?
  devices             Device[]
  events              Event[]

  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String
  tokenHash   String   @unique
  family      String   // For reuse detection
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([family])
  @@map("refresh_tokens")
}

model PlayerProgress {
  id            String   @id @default(uuid())
  userId        String   @unique
  progressData  Json
  version       Int      @default(1)  // Optimistic concurrency
  savedAt       DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("player_progress")
}

model Device {
  id                  String   @id @default(uuid())
  userId              String
  platform            String   // "ios" | "android"
  onesignalPlayerId   String?
  deviceToken         String?
  isActive            Boolean  @default(true)
  registeredAt        DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([onesignalPlayerId])
  @@map("devices")
}

model Event {
  id          String   @id @default(uuid())
  userId      String
  eventType   String
  payload     Json?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("events")
}

model PushCampaign {
  id                String   @id @default(uuid())
  createdByAdminId  String
  title             String
  message           String
  deepLink          String?
  audienceType      String   // "ALL" | "USERS" | "TAGS"
  audiencePayload   Json?
  scheduleAt        DateTime?
  status            String   @default("DRAFT")  // DRAFT | SCHEDULED | SENDING | SENT | CANCELLED | FAILED
  onesignalResponse Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  sendLogs          PushSendLog[]

  @@map("push_campaigns")
}

model PushSendLog {
  id          String   @id @default(uuid())
  campaignId  String?
  userId      String
  deviceId    String
  status      String   // "SENT" | "FAILED" | "DELIVERED"
  response    Json?
  sentAt      DateTime @default(now())

  campaign    PushCampaign? @relation(fields: [campaignId], references: [id])

  @@index([campaignId])
  @@index([userId])
  @@map("push_send_logs")
}
