---
phase: 01-aws-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/server.js
  - package.json
  - ecosystem.config.js
autonomous: false

user_setup:
  - service: hostinger
    why: "DNS A record for api-staging subdomain"
    dashboard_config:
      - task: "Add A record pointing to EC2 Elastic IP"
        location: "Hostinger Control Panel -> DNS Zone Editor"

must_haves:
  truths:
    - "Node.js 20 LTS, PM2, and Nginx are installed on EC2"
    - "Health check app responds at localhost:3000/health"
    - "PM2 manages the app process and survives reboot"
    - "Nginx reverse proxies port 80 to localhost:3000"
    - "DNS A record points api-staging subdomain to Elastic IP"
    - "HTTPS certificate is active via Let's Encrypt"
    - "GET https://api-staging.{domain}/health returns {status: ok} with 200"
  artifacts:
    - path: "src/server.js"
      provides: "Express health check endpoint"
      min_lines: 10
    - path: "package.json"
      provides: "Node.js project manifest with express dependency"
      contains: "express"
    - path: "ecosystem.config.js"
      provides: "PM2 process configuration"
      contains: "radstrat-api"
  key_links:
    - from: "Nginx (port 443)"
      to: "Node.js (localhost:3000)"
      via: "proxy_pass reverse proxy"
      pattern: "proxy_pass http://localhost:3000"
    - from: "DNS A record"
      to: "EC2 Elastic IP"
      via: "Hostinger DNS zone"
      pattern: "nslookup api-staging.domain returns Elastic IP"
    - from: "Let's Encrypt"
      to: "Nginx"
      via: "certbot --nginx"
      pattern: "ssl_certificate /etc/letsencrypt"
---

<objective>
Install Node.js stack on EC2, deploy health check app, configure Nginx + SSL, and verify end-to-end HTTPS access.

Purpose: Completes the infrastructure phase by installing all software, deploying a minimal health check app, configuring the reverse proxy with SSL, and verifying the full chain works. After this plan, GET /health returns 200 over HTTPS -- the phase success criteria.

Output: Working HTTPS endpoint at api-staging.{domain}/health returning {"status":"ok"}, with PM2 managing the Node.js process and Nginx handling SSL termination.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-aws-infrastructure/01-CONTEXT.md
@.planning/phases/01-aws-infrastructure/01-RESEARCH.md
@.planning/phases/01-aws-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-aws-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Install Software Stack and Deploy Health Check</name>
  <action>
Guide the user through SSH commands to install Node.js, PM2, Nginx, and deploy the health check app.

**Step 1: SSH into EC2**

```bash
ssh -i ~/.ssh/radstrat-keypair.pem ubuntu@{ELASTIC_IP}
```

**Step 2: System Update**

```bash
sudo apt update && sudo apt upgrade -y
```

**Step 3: Install Node.js 20 LTS (via NodeSource)**

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install nodejs -y
```

Verify:
```bash
node -v    # Should show v20.x.x
npm -v     # Should show 10.x.x or higher
```

WARNING: Do NOT use `sudo apt install nodejs` without the NodeSource setup first -- that installs an old version.

**Step 4: Install PM2 Globally**

```bash
sudo npm install pm2@latest -g
pm2 -v     # Should show 5.x.x
```

**Step 5: Install Nginx**

```bash
sudo apt install nginx -y
sudo systemctl status nginx    # Should show "active (running)"
```

**Step 6: Install Certbot**

```bash
sudo apt install certbot python3-certbot-nginx -y
```

**Step 7: Install PostgreSQL Client (for future use)**

```bash
sudo apt install postgresql-client -y
```

**Step 8: Create Project Directory and Health Check App**

```bash
# Create project directory
mkdir -p ~/radstrat-api/src
mkdir -p ~/radstrat-api/logs
cd ~/radstrat-api
```

Create `package.json`:
```bash
cat > package.json << 'EOF'
{
  "name": "radstrat-api",
  "version": "1.0.0",
  "description": "RADStrat Backend API",
  "main": "src/server.js",
  "scripts": {
    "start": "node src/server.js"
  },
  "dependencies": {
    "express": "^4.21.0"
  }
}
EOF
```

Create `src/server.js`:
```bash
cat > src/server.js << 'EOF'
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.get('/health', (req, res) => {
  res.status(200).json({ status: 'ok' });
});

app.listen(PORT, () => {
  console.log(`RADStrat API running on port ${PORT}`);
});
EOF
```

Create `ecosystem.config.js`:
```bash
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'radstrat-api',
    script: './src/server.js',
    instances: 1,
    exec_mode: 'fork',
    max_memory_restart: '500M',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    watch: false,
    max_restarts: 10,
    min_uptime: '10s'
  }]
};
EOF
```

**Step 9: Install Dependencies and Start App**

```bash
cd ~/radstrat-api
npm install
pm2 start ecosystem.config.js
```

Verify:
```bash
pm2 list                           # Should show radstrat-api as "online"
curl http://localhost:3000/health   # Should return {"status":"ok"}
```

**Step 10: Configure PM2 Startup (Auto-Start on Reboot)**

```bash
pm2 save
pm2 startup
```

PM2 will output a command starting with `sudo env PATH=...`. Copy and run that exact command. Then:
```bash
pm2 save    # Save again after startup config
```
  </action>
  <verify>
User confirms from the EC2 SSH session:

1. `node -v` shows v20.x.x
2. `pm2 list` shows radstrat-api as "online"
3. `curl http://localhost:3000/health` returns `{"status":"ok"}`
4. PM2 startup configured (ran the sudo command from `pm2 startup` output)
  </verify>
  <done>
Node.js 20 LTS, PM2, Nginx, and certbot installed. Health check app deployed and running via PM2 on port 3000. PM2 configured for auto-start on reboot.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Nginx, DNS, and SSL Certificate</name>
  <action>
Guide the user through Nginx reverse proxy setup, DNS configuration on Hostinger, and Let's Encrypt SSL certificate.

**Step 1: Configure Nginx Reverse Proxy (on EC2 via SSH)**

Create the site configuration:
```bash
sudo bash -c 'cat > /etc/nginx/sites-available/api-staging << EOF
server {
    listen 80;
    server_name api-staging.YOURDOMAIN.com;

    access_log /var/log/nginx/api-staging.access.log;
    error_log /var/log/nginx/api-staging.error.log;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection '"'"'upgrade'"'"';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF'
```

IMPORTANT: Replace `YOURDOMAIN.com` with the actual domain name.

Enable the site and remove default:
```bash
sudo ln -s /etc/nginx/sites-available/api-staging /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t          # Should show "syntax is ok" and "test is successful"
sudo systemctl reload nginx
```

**Step 2: Configure DNS on Hostinger**

1. Log in to Hostinger Control Panel
2. Go to DNS Zone Editor (or DNS Management)
3. Add a new record:
   - **Type:** A
   - **Name:** `api-staging` (just the subdomain prefix)
   - **Points to:** `{ELASTIC_IP}` (the Elastic IP from Plan 01)
   - **TTL:** 14400 (or default)
4. Save the record

**Step 3: Wait for DNS Propagation**

From your local machine (not EC2), check DNS:
```bash
nslookup api-staging.YOURDOMAIN.com
```

The answer should show the Elastic IP address. If it shows "NXDOMAIN" or wrong IP, wait a few minutes and try again. DNS propagation typically takes 5-15 minutes but can take up to an hour.

You can also check at: https://dnschecker.org

**Step 4: Verify HTTP Access (Before SSL)**

Once DNS resolves correctly, test from local machine:
```bash
curl http://api-staging.YOURDOMAIN.com/health
```

Should return `{"status":"ok"}`. If this works, DNS + Nginx + app chain is working.

**Step 5: Install SSL Certificate with Certbot**

On EC2 (SSH session):
```bash
sudo certbot --nginx -d api-staging.YOURDOMAIN.com
```

Certbot will:
1. Ask for email address (for renewal notifications) -- enter your email
2. Ask to agree to terms -- agree
3. Ask about sharing email -- your choice
4. Automatically configure Nginx for HTTPS
5. Set up auto-renewal via systemd timer

Verify auto-renewal:
```bash
sudo certbot renew --dry-run     # Should succeed with no errors
sudo systemctl status certbot.timer   # Should show "active"
```

**Step 6: Add HTTP Inbound Rule to EC2 Security Group (if needed for certbot)**

Note: Certbot HTTP-01 challenge needs port 80 accessible. If certbot fails, you may need to temporarily add an HTTP (80) inbound rule to ec2-app-sg:

1. AWS Console -> EC2 -> Security Groups -> ec2-app-sg
2. Edit inbound rules -> Add rule: Type = HTTP, Port = 80, Source = Anywhere-IPv4
3. Re-run certbot
4. You can keep port 80 open (Nginx redirects HTTP to HTTPS automatically)
  </action>
  <verify>
User confirms:

1. `sudo nginx -t` shows configuration is valid
2. `nslookup api-staging.YOURDOMAIN.com` returns the Elastic IP
3. Certbot completed successfully (shows "Congratulations" message)
4. `sudo certbot renew --dry-run` succeeds

Final end-to-end test from local machine:
```bash
curl https://api-staging.YOURDOMAIN.com/health
```

Must return: `{"status":"ok"}` with valid HTTPS (no certificate warnings).
  </verify>
  <done>
Nginx configured as reverse proxy, DNS A record pointing to Elastic IP, Let's Encrypt SSL certificate active with auto-renewal. HTTPS endpoint fully working.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete AWS infrastructure: EC2 with Node.js/PM2/Nginx, RDS PostgreSQL (private), security groups, Elastic IP, DNS, SSL certificate. Health check endpoint accessible over HTTPS.
  </what-built>
  <how-to-verify>
Run all Phase 1 success criteria checks:

1. **RDS Private Access:**
   - From EC2: `psql -h {RDS_ENDPOINT} -U radstrat_admin -d radstrat` -- should connect
   - From local: `psql -h {RDS_ENDPOINT} -U radstrat_admin -d radstrat` -- should timeout/fail

2. **EC2 Stack Verification:**
   - SSH into EC2: `ssh -i ~/.ssh/radstrat-keypair.pem ubuntu@{ELASTIC_IP}`
   - Run: `node -v` -- should show v20.x.x
   - Run: `pm2 list` -- should show radstrat-api as "online"
   - Run: `sudo nginx -t` -- should show "ok"

3. **Security Groups:**
   - AWS Console -> EC2 -> Security Groups
   - ec2-app-sg: SSH (22) + HTTPS (443) inbound [and HTTP (80) if added for certbot]
   - rds-db-sg: PostgreSQL (5432) from ec2-app-sg only

4. **HTTPS Health Check:**
   - Open browser: `https://api-staging.YOURDOMAIN.com/health`
   - Should show: `{"status":"ok"}`
   - Should show valid SSL certificate (green lock icon)
   - No certificate warnings

5. **SSL Certificate Details:**
   - Click lock icon in browser -> Certificate details
   - Issued by: Let's Encrypt
   - Valid for: api-staging.YOURDOMAIN.com
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 complete when ALL of these are true:

1. RDS Postgres accessible from EC2 only (psql test from EC2 succeeds, fails from elsewhere)
2. EC2 instance running with Node.js 20 LTS, PM2, and Nginx reverse proxy
3. Security groups: 443 (and optionally 80, 22) inbound to EC2, 5432 from EC2 SG to RDS
4. HTTPS endpoint responds at api-staging domain with valid certificate
5. GET /health returns `{"status":"ok"}` with 200
</verification>

<success_criteria>
- `curl https://api-staging.{domain}/health` returns `{"status":"ok"}` with 200 status
- Valid SSL certificate (no warnings)
- PM2 manages app with auto-start on reboot
- Nginx proxies HTTPS to Node.js on localhost:3000
- All 5 roadmap success criteria for Phase 1 are met
</success_criteria>

<output>
After completion, create `.planning/phases/01-aws-infrastructure/01-03-SUMMARY.md`

Record in summary:
- Full HTTPS URL (https://api-staging.{domain}.com)
- Node.js version installed
- PM2 version installed
- SSL certificate expiry date
- Full DATABASE_URL pattern: `postgresql://radstrat_admin:{password}@{RDS_ENDPOINT}:5432/radstrat`
- All success criteria pass/fail status
</output>
