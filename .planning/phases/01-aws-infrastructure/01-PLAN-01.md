---
phase: 01-aws-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: aws
    why: "EC2 instance and networking foundation"
    dashboard_config:
      - task: "Create EC2 security group"
        location: "AWS Console -> EC2 -> Security Groups"
      - task: "Create RDS security group"
        location: "AWS Console -> EC2 -> Security Groups"
      - task: "Launch EC2 instance"
        location: "AWS Console -> EC2 -> Launch Instance"
      - task: "Allocate and associate Elastic IP"
        location: "AWS Console -> EC2 -> Elastic IPs"

must_haves:
  truths:
    - "EC2 instance is running in ap-southeast-1 with Ubuntu 22.04 LTS"
    - "Elastic IP is allocated and associated with EC2 instance"
    - "EC2 security group allows inbound SSH (22) and HTTPS (443) only"
    - "RDS security group allows inbound PostgreSQL (5432) from EC2 SG only"
    - "User can SSH into EC2 instance using key pair"
  artifacts: []
  key_links:
    - from: "RDS Security Group"
      to: "EC2 Security Group"
      via: "SG ID reference as inbound source on port 5432"
      pattern: "Source: sg-* (ec2-app-sg)"
---

<objective>
Create EC2 instance with security groups and Elastic IP in ap-southeast-1 (Singapore).

Purpose: Establishes the compute foundation and network security rules that all subsequent infrastructure depends on. The EC2 security group must exist before the RDS security group can reference it, making this the required first step.

Output: Running EC2 instance with static IP, two properly configured security groups (EC2-SG and RDS-SG), SSH access confirmed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-aws-infrastructure/01-CONTEXT.md
@.planning/phases/01-aws-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Security Groups and Launch EC2</name>
  <action>
Guide the user through the following AWS Console steps. Present each step clearly and wait for confirmation before proceeding.

**Step 1: Create EC2 Security Group**

1. Go to AWS Console -> Services -> EC2
2. In the left sidebar, click "Security Groups" (under "Network & Security")
3. Click "Create security group"
4. Configure:
   - **Security group name:** `ec2-app-sg`
   - **Description:** `Security group for RADStrat API EC2 instance`
   - **VPC:** Select default VPC (should be pre-selected)
5. Inbound rules - click "Add rule" twice:
   - Rule 1: Type = `SSH`, Port = `22`, Source = `Anywhere-IPv4` (0.0.0.0/0)
   - Rule 2: Type = `HTTPS`, Port = `443`, Source = `Anywhere-IPv4` (0.0.0.0/0)
6. Outbound rules: Leave default (All traffic, 0.0.0.0/0)
7. Click "Create security group"
8. **IMPORTANT:** Note the Security Group ID (sg-xxxxxxxx) -- needed for RDS SG

**Step 2: Create RDS Security Group**

1. Still in EC2 -> Security Groups, click "Create security group"
2. Configure:
   - **Security group name:** `rds-db-sg`
   - **Description:** `Security group for RADStrat RDS PostgreSQL - EC2 access only`
   - **VPC:** Select default VPC (same VPC as EC2 SG)
3. Inbound rules - click "Add rule":
   - Rule 1: Type = `PostgreSQL`, Port = `5432`, Source = `Custom` -> type `ec2-app-sg` and select the security group from dropdown (NOT an IP address)
4. Outbound rules: Leave default
5. Click "Create security group"

**Step 3: Create EC2 Key Pair**

1. In EC2 left sidebar, click "Key Pairs" (under "Network & Security")
2. Click "Create key pair"
3. Configure:
   - **Name:** `radstrat-keypair`
   - **Key pair type:** RSA
   - **Private key file format:** .pem (for Mac/Linux)
4. Click "Create key pair" -- the .pem file downloads automatically
5. Move the file to a safe location and set permissions:
   ```
   mv ~/Downloads/radstrat-keypair.pem ~/.ssh/
   chmod 400 ~/.ssh/radstrat-keypair.pem
   ```

**Step 4: Launch EC2 Instance**

1. Go to EC2 -> "Launch Instance"
2. Configure:
   - **Name:** `radstrat-api`
   - **Application and OS Images:** Ubuntu -> Ubuntu Server 22.04 LTS (64-bit x86) -- should be in "Quick Start"
   - **Instance type:** `t3.small`
   - **Key pair:** Select `radstrat-keypair`
   - **Network settings:** Click "Edit"
     - **VPC:** Default VPC
     - **Subnet:** No preference (any AZ is fine)
     - **Auto-assign public IP:** Enable
     - **Firewall (security groups):** Select existing security group -> choose `ec2-app-sg`
   - **Storage:** 20 GB gp3 (default is fine)
3. Click "Launch instance"
4. Wait for instance state to show "Running" (1-2 minutes)

**Step 5: Allocate and Associate Elastic IP**

1. In EC2 left sidebar, click "Elastic IPs" (under "Network & Security")
2. Click "Allocate Elastic IP address"
3. Leave defaults (Amazon's pool of IPv4 addresses), click "Allocate"
4. Select the new Elastic IP -> Actions -> "Associate Elastic IP address"
5. Configure:
   - **Resource type:** Instance
   - **Instance:** Select `radstrat-api`
6. Click "Associate"
7. **Note the Elastic IP address** -- this is the permanent public IP for DNS and SSH
  </action>
  <verify>
Ask the user to confirm the following and provide values:

1. What is the Elastic IP address? (e.g., 13.xxx.xxx.xxx)
2. What is the EC2 Security Group ID? (e.g., sg-0abc123)
3. What is the RDS Security Group ID? (e.g., sg-0def456)

Then verify SSH access works:
```
ssh -i ~/.ssh/radstrat-keypair.pem ubuntu@{ELASTIC_IP}
```
User should see Ubuntu welcome message and `ubuntu@ip-xxx:~$` prompt.
  </verify>
  <done>
EC2 instance running in ap-southeast-1, Elastic IP associated, both security groups created (ec2-app-sg with SSH+HTTPS inbound, rds-db-sg with PostgreSQL from ec2-app-sg), SSH access confirmed.
  </done>
</task>

</tasks>

<verification>
- EC2 instance state: "Running" in AWS Console
- Elastic IP: Associated with EC2 instance (visible in instance details)
- ec2-app-sg inbound rules: SSH (22) from 0.0.0.0/0, HTTPS (443) from 0.0.0.0/0
- rds-db-sg inbound rules: PostgreSQL (5432) from ec2-app-sg (SG reference, not IP)
- SSH connection: `ssh -i ~/.ssh/radstrat-keypair.pem ubuntu@{ELASTIC_IP}` succeeds
</verification>

<success_criteria>
- EC2 instance is running and accessible via SSH
- Elastic IP is associated and noted for DNS configuration
- Both security groups exist with correct rules
- RDS SG references EC2 SG by ID (not by IP)
</success_criteria>

<output>
After completion, create `.planning/phases/01-aws-infrastructure/01-01-SUMMARY.md`

Record in summary:
- Elastic IP address
- EC2 instance ID
- EC2 Security Group ID (sg-xxx)
- RDS Security Group ID (sg-xxx)
- Key pair file location
</output>
