---
phase: 01-aws-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: []
autonomous: false

user_setup:
  - service: aws
    why: "RDS PostgreSQL database instance"
    dashboard_config:
      - task: "Create RDS PostgreSQL instance"
        location: "AWS Console -> RDS -> Create database"

must_haves:
  truths:
    - "RDS PostgreSQL instance is running in ap-southeast-1"
    - "RDS is NOT publicly accessible"
    - "RDS accepts connections from EC2 instance only (via rds-db-sg)"
    - "psql connection from EC2 to RDS succeeds"
    - "psql connection from outside EC2 fails (cannot reach RDS)"
  artifacts: []
  key_links:
    - from: "EC2 instance"
      to: "RDS instance"
      via: "Security group reference on port 5432"
      pattern: "psql -h rds-endpoint -U dbuser succeeds from EC2"
---

<objective>
Create RDS PostgreSQL instance with private access restricted to EC2 only.

Purpose: Establishes the managed database that will store user accounts, game progress, and session data. RDS must be private (no public access) with connections restricted to the EC2 security group created in Plan 01.

Output: Running RDS PostgreSQL instance, connectivity verified from EC2 via psql, database endpoint noted for application configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-aws-infrastructure/01-CONTEXT.md
@.planning/phases/01-aws-infrastructure/01-RESEARCH.md
@.planning/phases/01-aws-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create RDS PostgreSQL Instance</name>
  <action>
Guide the user through the RDS creation wizard. This is the highest-risk step -- the "Publicly accessible" setting MUST be set to "No".

**Step 1: Open RDS Console**

1. Go to AWS Console -> Services -> RDS
2. Make sure region is set to **Asia Pacific (Singapore) ap-southeast-1** (top-right dropdown)
3. Click "Create database"

**Step 2: Database Creation Method**

1. Select "Standard create" (NOT Easy create -- we need control over security settings)

**Step 3: Engine Options**

1. **Engine type:** PostgreSQL
2. **Engine version:** PostgreSQL 16.x (latest available 16.x version)

**Step 4: Templates**

1. Select "Free tier" if available, otherwise "Dev/Test"
   - Free tier automatically selects db.t3.micro -- this is what we want

**Step 5: Settings**

1. **DB instance identifier:** `radstrat-db`
2. **Master username:** `radstrat_admin`
3. **Credentials management:** Self managed
4. **Master password:** Choose a strong password (16+ chars, mixed case, numbers, symbols)
5. **Confirm password:** Re-enter the password
6. **IMPORTANT:** Save this password securely -- you'll need it for DATABASE_URL

**Step 6: Instance Configuration**

1. **DB instance class:** Burstable classes -> `db.t3.micro`

**Step 7: Storage**

1. **Storage type:** gp3
2. **Allocated storage:** 20 GB
3. **Storage autoscaling:** Uncheck "Enable storage autoscaling" (not needed for SIT)

**Step 8: Connectivity -- CRITICAL SECTION**

1. **Compute resource:** "Don't connect to an EC2 compute resource" (we use security groups instead)
2. **Network type:** IPv4
3. **VPC:** Default VPC (same VPC as your EC2 instance)
4. **DB subnet group:** Default
5. **Public access:** **NO** -- THIS IS CRITICAL. Select "No".
   - WARNING: Some console versions default to "Yes". Double-check this is "No".
6. **VPC security group:** "Choose existing"
   - Remove the default security group
   - Select `rds-db-sg` (the RDS security group created in Plan 01)
7. **Availability Zone:** No preference

**Step 9: Database Authentication**

1. Select "Password authentication"

**Step 10: Additional Configuration**

1. **Initial database name:** `radstrat`
2. **Backup retention period:** 7 days (default)
3. **Enable deletion protection:** Uncheck for now (SIT environment)
4. Leave other defaults

**Step 11: Create**

1. Review all settings one more time
2. **VERIFY:** Public access = No, Security group = rds-db-sg
3. Click "Create database"
4. Wait for status to show "Available" (this takes 5-10 minutes)
5. Once available, click on the database name to see details
6. **Note the Endpoint** under "Connectivity & security" (e.g., `radstrat-db.xxxx.ap-southeast-1.rds.amazonaws.com`)
  </action>
  <verify>
Ask the user to confirm:

1. What is the RDS endpoint? (e.g., radstrat-db.xxxx.ap-southeast-1.rds.amazonaws.com)
2. What is the master username? (should be radstrat_admin)
3. What is the initial database name? (should be radstrat)
4. Is "Publicly accessible" showing "No" in the instance details?

Record the RDS endpoint -- it will be needed for DATABASE_URL in Plan 03.
  </verify>
  <done>
RDS PostgreSQL instance is running with status "Available", publicly accessible = No, using rds-db-sg security group.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Verify RDS Connectivity from EC2</name>
  <action>
Guide the user through SSH and psql connectivity test. This validates that the security group chain (EC2-SG -> RDS-SG) is working correctly.

**Step 1: SSH into EC2**

```bash
ssh -i ~/.ssh/radstrat-keypair.pem ubuntu@{ELASTIC_IP}
```

(Use the Elastic IP from Plan 01)

**Step 2: Install PostgreSQL Client**

```bash
sudo apt update
sudo apt install postgresql-client -y
```

**Step 3: Test RDS Connection**

```bash
psql -h {RDS_ENDPOINT} -U radstrat_admin -d radstrat
```

- When prompted for password, enter the master password set during RDS creation
- Expected result: You should see `radstrat=>` prompt
- Type `SELECT version();` to confirm PostgreSQL version
- Type `\q` to exit

**Step 4: Verify Private Access (from local machine, NOT EC2)**

From your local terminal (NOT the SSH session), try:

```bash
psql -h {RDS_ENDPOINT} -U radstrat_admin -d radstrat
```

This should FAIL with a timeout or connection refused. This confirms RDS is not publicly accessible.

**If psql from EC2 fails with timeout:**
- Check rds-db-sg inbound rules -- Source must be ec2-app-sg (SG ID), not an IP
- Check both EC2 and RDS are in the same VPC
- Check RDS status is "Available"
  </action>
  <verify>
User confirms:
1. `psql` from EC2 connects successfully and shows `radstrat=>` prompt
2. `SELECT version();` returns PostgreSQL 16.x
3. `psql` from local machine times out or is refused (private access confirmed)
  </verify>
  <done>
RDS PostgreSQL is accessible from EC2 only. Security group chain validated. Database endpoint and credentials confirmed working.
  </done>
</task>

</tasks>

<verification>
- RDS instance status: "Available" in AWS Console
- RDS "Publicly accessible": Shows "No" in instance details
- RDS security group: rds-db-sg assigned
- psql from EC2: Connects successfully to radstrat database
- psql from local machine: Fails (timeout/refused) -- confirms private access
</verification>

<success_criteria>
- RDS PostgreSQL 16.x running in ap-southeast-1
- Publicly accessible = No
- Security group rds-db-sg with PostgreSQL (5432) from ec2-app-sg only
- Verified connectivity from EC2 (psql succeeds)
- Verified NO connectivity from outside EC2 (psql fails)
</success_criteria>

<output>
After completion, create `.planning/phases/01-aws-infrastructure/01-02-SUMMARY.md`

Record in summary:
- RDS endpoint (radstrat-db.xxxx.ap-southeast-1.rds.amazonaws.com)
- Database name (radstrat)
- Master username (radstrat_admin)
- PostgreSQL version confirmed
- Connectivity test results (EC2: pass, external: fail)
</output>
